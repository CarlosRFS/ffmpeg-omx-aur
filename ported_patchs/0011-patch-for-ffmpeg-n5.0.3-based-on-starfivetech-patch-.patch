From e0f4c1d724f29d04398d69fc3d08e1dd354d3450 Mon Sep 17 00:00:00 2001
From: Carlos Raimundo de Freitas Sotero <carlosrfs99@gmail.com>
Date: Mon, 25 Sep 2023 03:23:35 -0300
Subject: [PATCH] patch for ffmpeg n5.0.3, based on starfivetech patch for add
 delay for decoding. Original Patch:
 https://github.com/starfive-tech/Debian/raw/v0.9.0-engineering-release-wayland/multimedia/patch/ffmpeg/0011-ffmpeg-add-delay-for-decoding.patch

---
 libavcodec/omxdec.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/libavcodec/omxdec.c b/libavcodec/omxdec.c
index 51da429ae9..aedd58c166 100644
--- a/libavcodec/omxdec.c
+++ b/libavcodec/omxdec.c
@@ -264,7 +264,7 @@ typedef struct OMXCodecContext {
 
     int mutex_cond_inited;
 
-    int eos_sent, got_eos, evnet_bufferflag;
+    int eos_sent, got_eos, evnet_bufferflag, first_get_outbuffer;
 
        int extradata_sent;
 
@@ -797,6 +797,10 @@ static int omx_decode_frame(AVCodecContext *avctx, void *data,
        int linesize[4];
 
     if (pkt->size) {
+	
+	//VPU init and fill buffer slow, so empty buf sleep to send before get vpu fill buf.
+        if(!s->first_get_outbuffer)
+        	av_usleep(100000);
 
         buffer = get_buffer(&s->input_mutex, &s->input_cond,
                             &s->num_free_in_buffers, s->free_in_buffers, 1);
@@ -837,6 +841,8 @@ static int omx_decode_frame(AVCodecContext *avctx, void *data,
            }
     } else if (!s->eos_sent) {
 
+	if(!s->first_get_outbuffer)
+		av_usleep(1000000);
         buffer = get_buffer(&s->input_mutex, &s->input_cond,
                             &s->num_free_in_buffers, s->free_in_buffers, 1);
 
@@ -875,6 +881,8 @@ static int omx_decode_frame(AVCodecContext *avctx, void *data,
         }
                //if (!buffer)
            // break;
+	 if(!s->first_get_outbuffer)
+		 s->first_get_outbuffer = 1;
 
                if(!buffer->nFilledLen) {
 		       av_log(avctx, AV_LOG_ERROR, "buffer->nFilledLen %d\n", (int)buffer->nFilledLen);
-- 
2.41.0

