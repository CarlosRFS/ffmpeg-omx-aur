From fca27c3ae3e0ef494523f2ac458e85b9353ef056 Mon Sep 17 00:00:00 2001
From: Carlos Raimundo de Freitas Sotero <carlosrfs99@gmail.com>
Date: Sun, 1 Oct 2023 16:48:07 -0300
Subject: [PATCH 4/6] support to change gop of hevc for omx encoder on ffmpeg
 n6.0 based on starfive tech patches:
 https://github.com/starfive-tech/Debian/tree/20221225T084846Z/multimedia/patch/ffmpeg

---
 libavcodec/omx.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/libavcodec/omx.c b/libavcodec/omx.c
index 1f900e14b8..3fca988c9f 100644
--- a/libavcodec/omx.c
+++ b/libavcodec/omx.c
@@ -28,6 +28,8 @@
 #include <dlfcn.h>
 #include <OMX_Core.h>
 #include <OMX_Component.h>
+#include <OMX_IndexExt.h>
+#include <OMX_VideoExt.h>
 #include <pthread.h>
 #include <stdio.h>
 #include <stdlib.h>
@@ -552,6 +554,16 @@ static av_cold int omx_component_init(AVCodecContext *avctx, const char *role)
         }
         err = OMX_SetParameter(s->handle, OMX_IndexParamVideoAvc, &avc);
         CHECK(err);
+    } else if (avctx->codec->id == AV_CODEC_ID_HEVC) 
+    	OMX_VIDEO_PARAM_AVCTYPE hevc = { 0 };
+        INIT_STRUCT(hevc);
+	hevc.nPortIndex = s->out_port;
+	err = OMX_GetParameters(s->handle, OMX_IndexParamVideoHevc, &hevc);
+	CHECK(err);
+	hevc.nBFrames = 0;
+	hevc.nPFrames = avctx->gop_size;
+	err = OMX_SetParameter(s->handle, OMX_IndexParamVideoHevc, &hevc);
+	CHECK(err);
     }
 
     err = OMX_SendCommand(s->handle, OMX_CommandStateSet, OMX_StateIdle, NULL);
-- 
2.41.0

