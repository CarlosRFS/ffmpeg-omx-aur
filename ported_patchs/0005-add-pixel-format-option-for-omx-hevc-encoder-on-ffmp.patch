From 646e8eca33e1420d986189eec7e02cff3f0e49a7 Mon Sep 17 00:00:00 2001
From: Carlos Raimundo de Freitas Sotero <carlosrfs99@gmail.com>
Date: Sun, 1 Oct 2023 17:07:41 -0300
Subject: [PATCH 5/6] add pixel format option for omx hevc encoder on ffmpeg
 n6.0 based on starfive tech patches:
 https://github.com/starfive-tech/Debian/tree/20221225T084846Z/multimedia/patch/ffmpeg

---
 libavcodec/omx.c | 17 +++++++++++++++--
 1 file changed, 15 insertions(+), 2 deletions(-)

diff --git a/libavcodec/omx.c b/libavcodec/omx.c
index 3fca988c9f..8a13cc6dbe 100644
--- a/libavcodec/omx.c
+++ b/libavcodec/omx.c
@@ -468,13 +468,26 @@ static av_cold int omx_component_init(AVCodecContext *avctx, const char *role)
         return AVERROR_UNKNOWN;
     }
 
+    av_log(avctx, AV_LOG_VERBOSE, "OMX setting pixel_format:%s\n", av_get_pix_fmt_name(avctx->pix_fmt));
     in_port_params.bEnabled   = OMX_TRUE;
     in_port_params.bPopulated = OMX_FALSE;
     in_port_params.eDomain    = OMX_PortDomainVideo;
 
     in_port_params.format.video.pNativeRender         = NULL;
     in_port_params.format.video.bFlagErrorConcealment = OMX_FALSE;
-    in_port_params.format.video.eColorFormat          = s->color_format;
+    switch (avctx->pix_fmt) {
+         case AV_PIX_FMT_NV12:
+             in_port_params.format.video.eColorFormat = OMX_COLOR_FormatYUV420SemiPlanar;
+             break;
+         case AV_PIX_FMT_NV21:
+             in_port_params.format.video.eColorFormat = OMX_COLOR_FormatYVU420SemiPlanar;
+             break;
+         case AV_PIX_FMT_YUV420P:
+             out_port_params.format.video.eColorFormat = OMX_COLOR_FormatYUV420Planar;
+             break;
+         default:
+             return AVERROR_OPTION_NOT_FOUND;
+    }
     s->stride     = avctx->width;
     s->plane_size = avctx->height;
     // If specific codecs need to manually override the stride/plane_size,
@@ -971,7 +984,7 @@ static const AVOption options_hevc[] = {
 };
 
 static const enum AVPixelFormat omx_encoder_pix_fmts[] = {
-    AV_PIX_FMT_YUV420P, AV_PIX_FMT_NONE
+    AV_PIX_FMT_YUV420P, AV_PIX_FMT_NV12, AV_PIX_FMT_NV21, AV_PIX_FMT_NONE
 };
 
 static const AVClass omx_mpeg4enc_class = {
-- 
2.41.0

